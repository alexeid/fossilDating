%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[xcolor=pdftex,dvipsnames,table,10pt]{beamer}
%handout, if no \pause

\usepackage{tabularx}
\usepackage{tikz}
\usepackage[]{algorithm2e}
\usepackage{listings}
\usepackage{lstautogobble}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{amsmath}
\usepackage{xcolor}
\usepackage{subfigure}
\usepackage[style=authoryear,backend=biber,mincitenames=1,maxcitenames=2, uniquelist=false]{biblatex}
\bibliography{fossilDating.bib}

\newcommand{\Mstrict}{{M1}}
\newcommand{\Mrelaxed}{{M8}}
% turnover = birth / death
\newcommand{\turnover}{\nu}

% sampling proportion = \psi / \psi + \mu
\newcommand{\fosp}{s}
\newcommand{\sampleprop}{sampling proportion}


\definecolor{newblue}{rgb}{0.3, 0.5, 0.9}
\definecolor{newblue1}{rgb}{0.3, 0.3, 0.7}
\definecolor{newred}{RGB}{200,0,0}



%\documentclass[handout,xcolor=pdftex,dvipsnames,table]{beamer} % USE THIS WITH pdfpages STUFF
%\usepackage{pgfpages}
%\pgfpagesuselayout{resize to}[a4paper, landscape]

\definecolor{headerColour}{RGB}{180, 230, 245}
\definecolor{headerTitleColour}{RGB}{0, 60, 80}
\definecolor{sectionShadedColour}{RGB}{50, 110, 130}
\definecolor{subsectionHighlightColour}{RGB}{50, 50, 50}
\definecolor{subsectionShadedColour}{RGB}{100, 100, 100}

\setbeamercolor{subsection in sidebar}{fg=subsectionHighlightColour}
\setbeamercolor{subsection in sidebar shaded}{fg=subsectionShadedColour}
\setbeamercolor{structure}{fg=headerTitleColour, bg=headerColour}
\setbeamercolor{title}{fg=headerTitleColour, bg=white}
\setbeamercolor{section in sidebar shaded}{fg=sectionShadedColour}

\usetheme{Goettingen}
\makeatletter\setbeamertemplate{sidebar canvas \beamer@sidebarside}[vertical shading][top=headerColour,bottom=white]\makeatother

%% to suppress subsections in sidebar:
%\setbeamertemplate{subsection in sidebar shaded}
%{\vspace*{-\baselineskip}}
%\setbeamertemplate{subsubsection in sidebar shaded}
%{\vspace*{-\baselineskip}}

\usepackage{amsmath, amssymb}
\usepackage{fancyvrb}


% Font modification
\usefonttheme{professionalfonts}
\usepackage{cmbright}
\usepackage{eulervm}
\newfont{\Ss}{cmcsc12 scaled 1600}

% no navigation symbols at the bottom of frames
\beamertemplatenavigationsymbolsempty
\setbeamertemplate{footline}[frame number] 

\usepackage{multirow} % allows entries across multipe rows in tables
\usepackage{booktabs} % makes fancier rulers in tables
%\usepackage{setspace} % spacing between lines

%%%%%%%%%%%%%%%%%%
%% Bibliography related stuff:
% control space between lines
  \let\oldthebibliography=\thebibliography
  \let\endoldthebibliography=\endthebibliography
  \renewenvironment{thebibliography}[1]{
    \begin{oldthebibliography}{#1}
      \setlength{\parskip}{-0.5ex}
      \setlength{\itemsep}{-0.5ex}
  }{ \end{oldthebibliography} }
% Force entry to be in one line
\setbeamertemplate{bibliography entry title}{}
\setbeamertemplate{bibliography entry location}{}
\setbeamertemplate{bibliography entry note}{}
% Set bullet point shape:
\setbeamertemplate{bibliography item}{-}
%%%%%%%%%%%%%%


\newenvironment{items}{\begin{list}{$\bullet$}{\itemsep0ex plus 0.2ex
\parsep0ex plus 0.2ex \topsep0ex \parskip0ex}}{\end{list}}
\newcommand{\head}[1]
{\slide{\begin{center}\textbf{#1}\vspace*{-0.5\baselineskip}
{\color{red}\rule{\textwidth}{1mm}}\end{center}}}
\parskip0.3ex

\newcommand{\cT}{{\mathcal T}}


%\defbeamertemplate*{title page}{customized}[1][]
%{
%  \titlepage
%  \usebeamerfont{title}\inserttitle\par
%  \usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle\par
%  \bigskip
%  \usebeamerfont{author}\insertauthor\par
%  \usebeamerfont{institute}\insertinstitute\par
%  \usebeamerfont{date}\insertdate\par
%  \usebeamercolor[fg]{titlegraphic}\inserttitlegraphic
%}


\title[Total-evidence dating]{`Total-evidence' Bayesian estimation of phylogeny, divergence times and fossil ages}
\author[]{Alexei Drummond§}
\date{The Royal Society, London \\ 9th November 2015}
\institute{Professor of Computational Biology \\ Department of Computer Science \\ University of Auckland}
%\titlegraphic{\hspace*{8cm}\includegraphics[height=1.5cm]{figures/cEvo_logo_transparent.png}}
%{\small Link to Script\&Slides:  \url{http://www.tb.ethz.ch/education} 
%}

%%%%%%%%%%%%%% Figure caption setup
\usepackage[compatibility=false]{caption}
\captionsetup[figure]{labelsep=space,justification=centering}
\renewcommand{\figurename}{\scriptsize Figure adapted from}

% syntax: \figureCaption{Citation caption}{Second (real) caption}
% second caption can be skipped, first one has to be suppressed if you want to skip it
\newcommand\figureCaption[2]{%
  \captionsetup{aboveskip=0.1cm,belowskip=0cm}
  \caption{\scriptsize #1}
  \caption*{#2}
}

%%%%%%%%%%%%%% Fixme and comment setup¤
\definecolor{red}{HTML}{C92D39}
\definecolor{green}{HTML}{498A44}

% syntax: \fixme{What needs to be fixed}
\newcommand{\fixme}[1]{\textcolor{red}{\texttt{{\bf FIX ME:} #1}}}
% Hide all fixmes by switching the line above to this:
%\newcommand{\fixme}[1]{}

% syntax: \comment{Name of commenter}{C omment}
\newcommand{\comment}[2]{\textcolor{green}{{\bf Comment by {#1}}: #2}}
% Hide all comments by switching the line above to this:
%\newcommand{\comment}[2]{}

\begin{document}

%Slide1
\frame{\titlepage}

\section{Fossilized birth-death process}

\begin{frame}{The problem}

\begin{itemize}

\item We have 
\begin{itemize}
  \item \normalsize{{\bf molecular data} of extant species,} 
  \item \normalsize{{\bf morphological data} of extant and fossil species and }
  \item \normalsize{{\bf Fossil ages} (or geological time intervals).}
\end{itemize} 
\item We want to utilise all this data to learn about {\bf evolutionary history} and {\bf macroevolutionary processes}.
\item {\bf Bayesian statistical inference} is our preferred method of learning about the world.


\end{itemize}

\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}{Node dating}

\begin{itemize}
\item {\bf Divergence time dating is tricky :) }
\item {\bf A common practice is node dating}. One or more divergences in a phylogeny are assigned ages by identifying fossils of known geological age that correspond* to each divergence. 
\item This method has a few drawbacks:
\begin{itemize}
\item Often only the oldest fossil in a calibrated clade is used,
\item Calibration densities are often {\it ad hoc},
\item Difficult* to combine calibrations with tree priors,
\item Computational complexity of some methods mean that only a few nodes can be calibrated (Heled \& Drummond 2012).
\end{itemize}
\end{itemize}

\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}{Tip dating and total evidence}

Two main features of new method for divergence-time dating:
\begin{itemize}
\item Explicit modelling of fossilization events as a part of the tree branching process (Pyron 2011, Heath {\it et al} 2014),
\item Utilising all existing data \textcolor{newblue1}{(total evidence)} in a joint inference (Pyron 2011, Ronquist {\it et al} 2012).
\end{itemize}

\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%\begin{frame}{Total evidence}

%\begin{itemize}

%\item Pyron 2011 uses Lewis MK model to model evolution of morphological characters.  
%\item Ronquist et al 2012, Wood et al 2012. 
%\item They used Yule or Uniform tree prior. 
%\end{itemize}


%\end{frame}
 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}{Birth-death-sampling models}

\begin{figure}
  \begin{center}
               \input{pics/SampledTree1}
            \end{center}
            
         \end{figure}    
\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 


\begin{frame}{Birth-death-sampling models}


 \begin{figure}
            \begin{center}
               \input{pics/SampledTree2}
            \end{center}
            
         \end{figure}
    
\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 


\begin{frame} {Fossillized birth-death model (FBD)}


\begin{columns}[t]
\begin{column}{.5\textwidth}

Stadler 2010, Heath {\it et al} 2014. 
\vspace{0.2cm}

The process starts at time $t_{or}>0$ and ends at time zero (present time).  
  \vspace{0.01cm}
   \begin{itemize}
\item birth rate $\lambda$
\item death rate $\mu$
\item sampling rate $\psi$
\item sampling at present probability $\rho$ 
   \end{itemize}
\vspace{0.01cm}

   \end{column}
   \begin{column}{.5\textwidth}

            \begin{center}
               \input{pics/SATree2}
            \end{center}
         
         \begin{center}\emph{Sampled tree} \end{center}   

   \end{column}    
\end{columns}

\vspace{0.2cm}

Model parameters: \color{newblue1} $\eta = (t_{or}, \lambda, \mu, \psi, \rho)$.

\color{black}
All the parameters are identifiable. 

\vspace{1.5cm}


\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame} {Fossilized birth-death (FBD) skyline model}

Stadler \& K\"uhnert et al 2012, Gavryushkina {\it et al} 2014.

\vspace{0.2cm}

There are $k$ time intervals and parameters remain constants within the intervals but may vary from one interval to another

\begin{columns}[c]
\begin{column}{.5\textwidth}
\begin{itemize}
\item birth rates $\lambda_1, \ldots, \lambda_k$
\item death rates $\mu_1, \ldots, \mu_k$
\item sampling rates $\psi_1, \ldots, \psi_k$
\item sampling at time $t_k$ (present) probability $\rho$
\end{itemize}

\begin{center}
Model parameters:
\color{newblue1} $\eta = (t_{or}, \bar \lambda, \bar \mu, \bar \psi, \rho)$ 

\end{center}
  \end{column}
   \begin{column}{.5\textwidth}
\begin{center}
\input{pics/SkylineTree}
\end{center}
\begin{center}\emph{\small Sampled tree} \end{center}   
 \end{column}    
\end{columns}

\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iffalse 

\begin{frame}{Variation in the choice of the tree model parameters}

The $t_{or}$ parameter can be replaced with $t_{root}$ parameter assuming the process started with a branching event. 

\vskip2mm

Instead of $\lambda$, $\mu$, and $\psi$ we can also use an alternative parameterisation:

\renewcommand{\arraystretch}{1.2}

\begin{equation*} 
\begin{tabular}{ll} 
\text{net diversification rate} & $d = \lambda-\mu$  \\ 
\text{turnover rate} & $\turnover = \frac \mu \lambda$ \\ 
\text{\sampleprop} & $\fosp = \frac\psi {\mu + \psi}$  \\ 
\end{tabular} \end{equation*}

\end{frame}

\fi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}{Heath {\it et al} approach and its extensions}

 Heath {\it et al} 2014 first used FBD model to infer divergence times of bears in a Bayesian MCMC framework:  

\begin{itemize}
\item The topology of extant species is fixed
\item Only used occurrence dates of fossils, and no morphology 
\item Fixed $\rho$ to the truth in the inference
\end{itemize}

We extend this model in two ways:

\begin{itemize}
\item Sampling sampled ancestor trees (Gavryushkina {\it et al} 2014)
\item Incorparating morphological data
\end{itemize}

Implemented in SA and Morph-models packages for BEAST2 (\url{www.beast2.org})

\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}{Comparative data of fossil tips vs only occurrence dates}

\begin{figure}
\includegraphics[width=\textwidth]{pics/Height_SA/Rplots.pdf}
\end{figure}

\end{frame}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}{Comparative data of fossil tips vs only occurrence dates}

\setlength{\oddsidemargin}{0.1in} % adjust as necessary

\begin{columns}[c]

\begin{column}{.7\textwidth}
\begin{center}
\begin{figure}
\includegraphics[height=0.65\textheight]{pics/TurnoverHPD/Rplots.pdf}
\end{figure}
\end{center}
 \end{column}
 
\begin{column}{.3\textwidth}
\begin{center}
turnover~rate~=~$\frac \mu \lambda$ 
\end{center}
 \end{column}    
\end{columns}

\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}{Biased estimates when not modelling sampled ancestors}

\begin{figure}
\includegraphics[width=\textwidth]{pics/SAvsNoSA/Rplots.pdf}
\end{figure}

\begin{center}
diversification rate = $\lambda-\mu$ 
\end{center}

\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}{Analysis of penguin morphological data}

Penguin dataset (Ksepka et al 2012) consisting of morphological data of:
\begin{itemize}
\item all extant penguins (19 species)
\item 36 fossil species assigned to stratigraphic intervals
\end{itemize}

\vskip2mm

Models:

\begin{itemize}
\item Lewis MK vs MKv (Lewis 2001)
\item Partitions vs single alignment
\item Rate variation across sites and across partitions
\item Tree prior: FBD and Skyline FBD
\item Different tree model parameterisations
\end{itemize}


\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Parameterisations}

\renewcommand{\arraystretch}{1.2}

lmp:

\color{newblue1} 

\begin{equation*} 
\begin{tabular}{ll} 
\text{birth rate} & $\lambda$  \\ 
\text{death rate} & $\mu$ \\ 
\text{sampling rate} & $\psi$  \\ 
\textcolor{black}{other parameters} & \textcolor{black}{$t_{or}, \rho$} \\
\end{tabular} \end{equation*}

\textcolor{black}{dvs:}

\begin{equation*} 
\begin{tabular}{ll} 
\text{net diversification rate} & $d = \lambda-\mu$  \\ 
\text{turnover rate} & $\turnover = \frac \mu \lambda$ \\ 
\text{\sampleprop} & $\fosp = \frac\psi {\mu + \psi}$  \\ 
\textcolor{black}{other parameters} & \textcolor{black}{$t_{or}, \rho$} \\
\end{tabular} \end{equation*}



\end{frame}



\section{Penguin dating}

\begin{frame}
\begin{figure}
\includegraphics[width=0.7\textwidth]{../ag_morpho_data/figures/sa.pdf}
\label{saPostPr}
\end{figure}
\small{Probabilities of each fossil to be a sampled ancestor across models.

{\it P} stands for the partitioned model, {\it G} for gamma variation across sites, {\it Mkv} for conditioning on 
variable characters, {\it R} for relaxed clock model, {\it dns} for $d$, $\nu$, and $s$ tree prior parameterisation, {\it lmp} for $
\lambda$, $\mu$, and $\psi$ tree prior parameterisation.} 
\end{frame}

\begin{frame}
\begin{figure}
\includegraphics[width=\textwidth]{../ag_morpho_data/figures/pp.pdf}
\label{postPredictive}
\end{figure}
\small{The posterior and posterior predictive distributions for (left) tree length, $T$, and genealogical $D_F$ statistics and (right) $B_1$ tree imbalance statistic and Colless's tree imbalance index, $I_c$, for model 8. 

The posterior trees are on the unbalanced end of the predictive distribution.}
\end{frame}

\begin{frame}
\begin{figure}
\includegraphics[width=\textwidth]{../ag_morpho_data/figures/tree.pdf}
\label{penguinTree}
\end{figure}
\footnotesize{A maximum sampled ancestor clade credibility tree for the total-evidence analysis. % with mean node ages. 
The numbers in blue show the posterior supports of clades. The filled red and black circles represent sampled 
ancestors. Fossils with positive evidence of being sampled ancestors are shown in red.}

\end{frame}

\begin{frame}
\begin{figure}
\begin{center}
\includegraphics[width=0.75\textwidth]{../ag_morpho_data/figures/BayesFactors.pdf}
\label{fig:BF}
\end{center}
\end{figure}
\small{The evidence fossil sampled ancestors. The samples above the shaded area have positive evidence to be sampled ancestors and below the shaded area have positive evidence to be terminal nodes.}

\end{frame}

\begin{frame}
\begin{figure}
\includegraphics[width=0.95\textwidth]{../ag_morpho_data/figures/extant_tree.pdf}
\label{fig:divDates}
\end{figure}
\small{The posterior summary tree of extant penguins with 95\% HPD intervals and
posterior supports of clades after removing fossils.}
\end{frame}

\begin{frame}
\begin{figure}
\begin{center}
\includegraphics[width=0.75\textwidth]{../ag_morpho_data/figures/root_ages.pdf}
\label{fig:rootAges}
\end{center}
\end{figure}
\small{The age of root of extant penguins across models including total-evidence analysis under relaxed (8+DNA R) and strict (8+DND S) molecular clocks and 
total-evidence analysis with crown fossils only.}
\end{frame}

\begin{frame}
\frametitle{Dating the evolutionary history of penguins}
\begin{figure}
\includegraphics[width=\textwidth]{penguinTree.pdf}
\end{figure}
\end{frame}

\section{Fossil dating}

\begin{frame}{But what about those hyper parameter priors?}
\begin{figure}
\includegraphics[width=0.6\textwidth]{priors.pdf}
\label{Fig:Prior}
\end{figure}

\small{Prior density for sampling times under fossilized birth-death process. Dot-dashed line uses priors from \textcite{gavryushkina2015bayesian}. 
Solid line is new prior with implicit assumptions on $T$ and $s$, dashed line results from only assuming implicit prior on $T$,  dotted line results from only assuming implicit prior on $s$.}
\end{frame}

\begin{frame}{And what about this guy?}
\includegraphics[width=0.5\textwidth]{Homo_naledi.jpg}
\includegraphics[width=0.5\textwidth]{Atlantic_Homo_naledi.jpg}

\bigskip{}

{\bf Can we date fossils using Bayesian phylogenetics? }

\end{frame}


\begin{frame}{Yes, we can!}
\begin{figure}
\includegraphics[width=\textwidth]{Figure1.pdf}
\end{figure}
Bayesian phylogenetic age estimates for each of 36 penguin fossils plotted against their palaeontological age estimates, under two alternative evolutionary models. 
The blue line shows the $x=y$. If the vertical line doesn't cross $x=y$, then the midpoint of the geological range is not in the phylogenetic 95\% HPD. 
\end{frame}

\begin{frame}
\begin{figure}
\includegraphics[width=\textwidth]{8_penguins_eNprior/8_fossilDatingHist_younger_wide.pdf}
\end{figure}
Marginal posterior density plots for the phylogenetic age estimate of each of the 18 penguin fossils younger than 30 Myr using \Mrelaxed{}. Red boxes are the superimposed age ranges derived from geological data.
\end{frame}

\begin{frame}
\begin{figure}
\includegraphics[width=\textwidth]{8_penguins_eNprior/8_fossilDatingHist_older_wide.pdf}
\end{figure}
Marginal posterior density plots for the phylogenetic age estimate of each of the 18 penguin fossils older than 30 Myr using \Mrelaxed{}. Red boxes are the superimposed age ranges derived from geological data.
\end{frame}

\begin{frame}
\begin{figure}
\includegraphics[width=\textwidth]{Figure2.pdf}
\end{figure}
A plot of the number of non-ambiguous morphological sites for the taxon against the precision of the phylogenetic age for (a) \Mstrict{} and (b) \Mrelaxed{} (i.e. the precision is 1/variance in the marginal posterior distribution of the age).
\end{frame}

\begin{frame}
\frametitle{Comparison of age \& BF estimates between models}
\begin{figure}%
\centering
\subfigure[Estimated phylogenetic age of \Mstrict{} against \Mrelaxed{}.]{\includegraphics[width=0.45\textwidth]{compareAgeM1M8.pdf}}\qquad
\subfigure[Regression of Bayes factor (BF) for palaeontological range of \Mstrict{} against \Mrelaxed{}.]{\includegraphics[width=0.45\textwidth]{compareBFM1M8.pdf}}\\
\label{fig:compareM1M8ab}
\end{figure}
\end{frame}

\begin{frame}
\frametitle{Comparison of probability \& error between models}
\begin{figure}%
\centering
\subfigure[Regression of posterior probability of palaeontological range of \Mstrict{} against \Mrelaxed{}.]{\includegraphics[width=0.45\textwidth]{comparePostM1M8.pdf}}\qquad
\subfigure[Regression of error in estimated phylogenetic age of \Mstrict{} against \Mrelaxed{}.]{\includegraphics[width=0.45\textwidth]{compareErrorM1M8.pdf}}\\
\label{fig:compareM1M8cd}
\end{figure}
\end{frame}

\begin{frame}{Conclusions}
\end{frame}

\begin{frame}{Acknowledgements}
\begin{itemize}
\item Sasha Gavryushkina
\item Tanja Stadler
\item David Welch
\item Tracy Heath
\item Daniel Ksepka
\end{itemize}
\end{frame}

\end{document}
